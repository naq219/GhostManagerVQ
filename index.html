<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHÙA VIÊN QUANG - Thông Tin Hương Linh</title>
    <link rel="stylesheet" href="./css/style.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Vue.js 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- PocketBase -->
    <script src="https://unpkg.com/pocketbase@latest/dist/pocketbase.umd.js"></script>
    <!-- Fuse.js for fuzzy search -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    
</head>

<body>
    <div id="app">
        <div v-if="isAppLoading" class="loading-overlay">
            <div></div>
            <div style=" width: 100%; padding: 10px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-spinner fa-spin"></i> &nbsp; Đang tải dữ liệu...
            </div>
        </div>
        
        <header>
            <div class="container1">
                <h3>CHÙA VIÊN QUANG</h3>
                <p style="color: rgb(248, 174, 37);">Thông Tin Hương Linh</p>
                <nav>
                    <ul>
                        <li><a href="#" @click.prevent="currentPage = 'home'"
                                :class="{ active: currentPage === 'home' }">Trang chủ</a></li>
                        <li><a href="#" @click.prevent="currentPage = 'contact'"
                                :class="{ active: currentPage === 'contact' }">Liên hệ</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <main class="container">
            <!-- Trang chủ / Tra cứu -->
            <div class="ctn2">
                <div v-if="currentPage === 'home'">
                    <div class="search-container">
                        <div class="search-box">
                            <input type="text" v-model="searchQuery" :placeholder="getSearchPlaceholder()"
                                @keyup.enter="performSearch">
                            <button class="search-button" @click="performSearch">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>

                        <!-- Radio Button Options -->
                        <div class="search-options11">
                            <div class="toggle-group">
                                <button 
                                    class="toggle-item" 
                                    :class="{ active: searchType === 'all' }" 
                                    @click="searchType = 'all'; onSearchTypeChange()">
                                   
                                    Tất cả
                                </button>
                                <button 
                                    class="toggle-item" 
                                    :class="{ active: searchType === 'sender' }" 
                                    @click="searchType = 'sender'; onSearchTypeChange()">
                                   
                                    Người gửi
                                </button>
                                <button 
                                    class="toggle-item" 
                                    :class="{ active: searchType === 'spirit' }" 
                                    @click="searchType = 'spirit'; onSearchTypeChange()">
                                   
                                    Hương linh
                                </button>
                                <button 
                                    class="toggle-item" 
                                    :class="{ active: searchType === 'phone' }" 
                                    @click="searchType = 'phone'; onSearchTypeChange()">
                                    
                                    Điện thoại
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="search-results" v-if="searchResults.length > 0">
                        <h2>Kết quả tìm kiếm</h2>
                        <div class="result-cards">
                            <div class="card" v-for="result in searchResults" :key="result.id"
                                @click="showDetail(result)">
                                <h3>{{ result.hoten_die }}</h3>
                                <p><strong>Người gửi:</strong> {{ result.hoten_owner }}</p>
                                <p><strong>Vị trí:</strong> Bảng {{ result.bang }}, Hàng {{ result.hang }}, Cột {{
                                    result.cot }}</p>
                            </div>
                        </div>
                    </div>

                    <div class="no-results" v-else-if="hasSearched">
                        <p>Không tìm thấy kết quả phù hợp.</p>
                    </div>

                    <div v-show="!isAppLoading" class="welcome-message" v-else>
                        <p>Chọn loại tìm kiếm và nhập từ khóa để tra cứu thông tin hương linh.</p>
                    </div>
                </div>

                <!-- Trang chi tiết -->
                <div v-if="currentPage === 'detail'" class="detail-page">
                    <button class="back-button" @click="currentPage = 'home'">
                        <i class="fas fa-arrow-left"></i> Quay lại
                    </button>

                    <div class="detail-card">
                        <h2>{{ selectedRecord.hoten_die }}</h2>
                        <div class="detail-info">
                            <p><strong>Người gửi:</strong> {{ selectedRecord.hoten_owner }}</p>
                            <p><strong>Số điện thoại:</strong> {{ selectedRecord.phone }}</p>
                            <p><strong>Ngày mất:</strong> {{ selectedRecord.ngay_mat }}</p>
                            <p><strong>Ngày nhập linh:</strong> {{ formatDate(selectedRecord.ngay_nhap_linh) }}</p>
                            <p><strong>Vị trí bài vị:</strong> Bảng {{ selectedRecord.bang }}, Hàng {{
                                selectedRecord.hang }}, Cột {{ selectedRecord.cot }}</p>
                            <p v-if="selectedRecord.note"><strong>Ghi chú:</strong> {{ selectedRecord.note }}</p>
                        </div>
                    </div>
                </div>

                <!-- Trang liên hệ -->
                <div v-if="currentPage === 'contact'" class="contact-page">
                    <h2>Thông tin liên hệ</h2>
                    <div class="contact-info">
                        <div class="contact-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <p>Xóm Tháp Thổ, xã Nam Đàn, tỉnh Nghệ An</p>
                        </div>
                        <div class="contact-item">
                            <i class="fas fa-phone"></i>
                            <p>Số điện thoại: 0383668927</p>
                        </div>
                        
                        <div class="contact-item">
                            <i class="fas fa-clock"></i>
                            <p>Thời gian tiếp nhận: Các ngày trong tuần</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Khởi tạo ứng dụng Vue
        const { createApp, ref, reactive, computed, onMounted } = Vue;

        const app = createApp({
            setup() {
                // Khởi tạo PocketBase
                const pb = new PocketBase('http://103.163.118.103:401');

                const isAppLoading = ref(true);
                setTimeout(() => {
                    isAppLoading.value = false;
                }, 5000);
                


                // Trạng thái ứng dụng
                const currentPage = ref('home');
                const searchQuery = ref('');
                const searchType = ref('all'); // Thêm state cho loại tìm kiếm
                const searchResults = ref([]);
                const hasSearched = ref(false);
                const selectedRecord = ref({});
                const isLoading = ref(false);
                const errorMessage = ref('');

                // Cache dữ liệu
                const searchIndex = ref([]);
                const detailCache = ref(new Map());
                const currentPage_data = ref(1);
                const perPage = ref(500);
                const totalPages = ref(0);
                const isDataLoaded = ref(false);

                // Cấu hình Fuse.js cho từng loại tìm kiếm
                const getFuseOptions = (type) => {
                    const baseOptions = {
                        threshold: 0.3,
                        includeScore: true
                    };

                    switch (type) {
                        case 'sender':
                            return { ...baseOptions, keys: ['hoten_owner'] };
                        case 'spirit':
                            return { ...baseOptions, keys: ['hoten_die'] };
                        case 'phone':
                            return { ...baseOptions, keys: ['phone'] };
                        default: // 'all'
                            return { ...baseOptions, keys: ['hoten_die', 'hoten_owner', 'phone'] };
                    }
                };

                // Lấy placeholder phù hợp
                const getSearchPlaceholder = () => {
                    switch (searchType.value) {
                        case 'sender':
                            return 'Nhập tên người gửi...';
                        case 'spirit':
                            return 'Nhập tên hương linh...';
                        case 'phone':
                            return 'Nhập số điện thoại...';
                        default:
                            return 'Tên hoặc số điện thoại...';
                    }
                };

                // Xử lý khi thay đổi loại tìm kiếm
                const onSearchTypeChange = () => {
                    // Clear kết quả cũ khi thay đổi loại tìm kiếm
                    if (hasSearched.value) {
                        searchResults.value = [];
                        hasSearched.value = false;
                    }

                    // Nếu đang có từ khóa, tự động tìm kiếm lại
                    if (searchQuery.value.trim()) {
                        setTimeout(() => {
                            performSearch();
                        }, 100);
                    }
                };

                // Phát hiện thiết bị mobile
                const isMobile = () => {
                    return false;
                };

                // Tải dữ liệu tối thiểu cho tìm kiếm
                const fetchSearchIndex = async (page = 1, retryCount = 0) => {
                    try {
                        isLoading.value = true;
                        errorMessage.value = '';

                        const timeoutMs = isMobile() ? 15000 : 30000;
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

                        // Chỉ lấy trường cần thiết cho tìm kiếm và hiển thị danh sách
                        const records = await pb.collection('ghostmg').getList(page, perPage.value, {
                            sort: '-created',
                            fields: 'hoten_die,hoten_owner,phone,id,bang,hang,cot',
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        // Cập nhật search index
                        if (page === 1) {
                            searchIndex.value = records.items;
                        } else {
                            searchIndex.value = [...searchIndex.value, ...records.items];
                        }

                        totalPages.value = records.totalPages;
                        currentPage_data.value = page;
                        isDataLoaded.value = true;

                        console.log(`Đã tải search index trang ${page}: ${records.items.length} bản ghi`);
                        console.log(`Tổng search index: ${searchIndex.value.length}/${records.totalItems} bản ghi`);

                    } catch (error) {
                        console.error('Lỗi khi tải search index:', error);

                        // Retry logic
                        if (error.name === 'AbortError' && retryCount < 2) {
                            console.log(`Thử lại lần ${retryCount + 1}...`);
                            setTimeout(() => {
                                fetchSearchIndex(page, retryCount + 1);
                            }, 2000);
                            return;
                        }

                        if (error.name === 'AbortError') {
                            errorMessage.value = 'Kết nối quá chậm. Vui lòng kiểm tra mạng và thử lại.';
                        } else {
                            errorMessage.value = 'Không thể kết nối đến máy chủ. Vui lòng thử lại sau.';
                        }
                    } finally {
                        isLoading.value = false;
                    }
                };

                // Tải chi tiết record khi cần
                const fetchRecordDetail = async (recordId) => {
                    // Kiểm tra cache trước
                    if (detailCache.value.has(recordId)) {
                        return detailCache.value.get(recordId);
                    }

                    try {
                        // Lấy đầy đủ thông tin record
                        const record = await pb.collection('ghostmg').getOne(recordId, {
                            fields: 'id,hoten_die,hoten_owner,phone,bang,hang,cot,ngay_mat,ngay_nhap_linh,note,created,updated'
                        });

                        // Lưu vào cache
                        detailCache.value.set(recordId, record);

                        return record;
                    } catch (error) {
                        console.error('Lỗi khi tải chi tiết record:', error);
                        return null;
                    }
                };

                // Tải thêm dữ liệu search index
                const loadMoreSearchIndex = async () => {
                    if (currentPage_data.value < totalPages.value && !isLoading.value) {
                        await fetchSearchIndex(currentPage_data.value + 1);
                    }
                };

                // Tìm kiếm trong search index
                const performSearch = async () => {
                    const query = searchQuery.value.trim();
                    if (!query) {
                        searchResults.value = [];
                        hasSearched.value = false;
                        return;
                    }

                    hasSearched.value = true;

                    try {
                        // Nếu chưa có dữ liệu, tải search index đầu tiên
                        if (!isDataLoaded.value) {
                            await fetchSearchIndex(1);
                        }

                        // Tạo Fuse instance với cấu hình phù hợp
                        const fuseOptions = getFuseOptions(searchType.value);
                        const fuse = new Fuse(searchIndex.value, fuseOptions);

                        // Tìm kiếm
                        const results = fuse.search(query);
                        searchResults.value = results.map(result => result.item);

                        // Nếu kết quả ít và chưa tải hết search index, thử tải thêm
                        if (searchResults.value.length < 5 && currentPage_data.value < totalPages.value) {
                            console.log('Tìm kiếm ít kết quả, đang tải thêm search index...');
                            await loadMoreSearchIndex();

                            // Tạo lại Fuse với dữ liệu mới và tìm kiếm lại
                            const newFuse = new Fuse(searchIndex.value, fuseOptions);
                            const newResults = newFuse.search(query);
                            searchResults.value = newResults.map(result => result.item);
                        }

                    } catch (error) {
                        console.error('Lỗi khi tìm kiếm:', error);
                        errorMessage.value = 'Lỗi tìm kiếm. Vui lòng thử lại.';
                    }
                };

                // Hiển thị chi tiết hương linh
                const showDetail = async (record) => {
                    currentPage.value = 'detail';
                    selectedRecord.value = record;
                    console.log('showDetail', record);

                    // Tải chi tiết đầy đủ trong background
                    const fullRecord = await fetchRecordDetail(record.id);
                    if (fullRecord) {
                        selectedRecord.value = fullRecord;
                    }
                };

                // Format ngày tháng
                const formatDate = (dateString) => {
                    if (!dateString) return '';

                    try {
                        const date = new Date(dateString);
                        return date.toLocaleDateString('vi-VN', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    } catch (error) {
                        return dateString;
                    }
                };

                // Debounce search
                let searchTimeout;
                const debouncedSearch = () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        performSearch();
                    }, 300);
                };

                // Preload toàn bộ search index cho desktop
                const preloadAllSearchIndex = async () => {
                    if (!isMobile() && isDataLoaded.value) {
                        while (currentPage_data.value < totalPages.value) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            await loadMoreSearchIndex();
                        }
                        console.log('Đã preload toàn bộ search index');
                    }
                };

                // Khởi tạo
                onMounted(async () => {
                    // Tải search index đầu tiên
                    await fetchSearchIndex(1);

                    // Preload thêm cho desktop
                    setTimeout(preloadAllSearchIndex, 500);
                });

                return {
                    currentPage,
                    searchQuery,
                    searchType,
                    searchResults,
                    hasSearched,
                    selectedRecord,
                    isLoading,
                    isAppLoading,
                    errorMessage,
                    performSearch: debouncedSearch,
                    showDetail,
                    formatDate,
                    loadMoreSearchIndex,
                    currentPage_data,
                    totalPages,
                    isDataLoaded,
                    searchIndex,
                    fetchSearchIndex,
                    getSearchPlaceholder,
                    onSearchTypeChange
                };
            }
        });

        // Mount ứng dụng
        app.mount('#app');
    </script>
</body>

</html>